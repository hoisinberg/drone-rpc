syntax = "proto3";

import "google/protobuf/any.proto";

// RPC service exposed by orchestrators to drones, allowing drones to register themselves with the
// orchestrator from which they will receive commands.
service DroneOrchestratorService {

  // Expected to be invoked by drones as part of worker startup. Once the bidi stream is
  // established, it is used to propagate commands from the orchestrator to the worker.
  rpc RegisterDrone(stream DroneResponse) returns (stream DroneRequest) {}
}

// Requests sent from orchestrators to drones, representing commands sent from the orchestrator to
// the drone.
message DroneRequest {
  oneof data {
    // Data passed from orchestrator to drone during registration.
    InitResponse init_response = 1;

    // Framework-level request issued from orchestrator to drone.
    Framework framework = 2;

    // Application-level request issued from orchestrator to drone.
    App app = 3;
  }

  // Sent by orchestrators to drones confirming registration success.
  message InitResponse {
    // Framework-level metadata associated with drone registration.
    Metadata metadata = 1;

    // Application-level data associated with drone registration.
    google.protobuf.Any data = 2;

    message Metadata {}
  }

  // Sent from orchestrators to drones for framework-level requests like health checks.
  message Framework {}

  // Sent from orchestators to drones in order to initiate application-level requests.
  message App {
    // Framework-level metadata associated with application-level requests.
    Metadata metadata = 1;

    google.protobuf.Any data = 2;

    message Metadata {}
  }
}

// Responses sent from drones to orchestrators in response to incoming commands. Aside from
// registration, drones should only send these in response to requests sent by orchestrators.
message DroneResponse {
  oneof data {
    // Set when a drone is establishing a connection with an orchestrator.
    InitRequest init = 1;

    // Drone response to a framework-level request.
    Framework framework = 2;

    // Drone response to an application-level request.
    App app = 3;
  }

  // Sent by drones during startup to establish a connection with an orchestrator.
  message InitRequest {
    // Framework-level metadata associated with drone registration.
    Metadata metadata = 1;

    // Application-level data associated with drone registration.
    google.protobuf.Any data = 2;

    message Metadata {}
  }

  // Sent from drones to orchestrators in response to framework-level requests like health checks.
  message Framework {}

  // Sent from drones to orchestrators in response to application-level requests.
  message App {
    // Framework-level metadata associated with application-level responses.
    Metadata metadata = 1;

    google.protobuf.Any data = 2;

    message Metadata {}
  }
}
